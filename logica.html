<html>
  <head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script type="text/javascript">

      var myVar;// = setInterval(alertFunc, 1000);
      var candleTick = 0;
      var candles = [['0',15,15,15,15]]
      var bookBuffer = []      
      var negocios = [['0',0]]
      var ultimoPreco = 1500;
      var tick = 0;
      var compraMercadoValor = 0;

      function startTrade(){
        inicarVariaveis();
        iniciarBook();
        google.charts.load('current', {'packages':['corechart','table']});
        google.charts.setOnLoadCallback(drawChart);      
        google.charts.setOnLoadCallback(drawTable);
        myVar = setInterval(alertFunc,5000);
      }

        function stopTrade(){
            if(myVar)
              clearInterval(myVar);
        }

        function alertFunc() {
            
            lancarOrdensNoBook()

            drawTable('Compra'); 
            drawTable('Venda'); 

            var price = ultimoPreco/100;
            
            if(candles[candleTick][1]> price)
                candles[candleTick][1] = price
            
            candles[candleTick][2] = price

            if(candles[candleTick][4]< price)
                candles[candleTick][4] = price
            
            tick++;
            if(tick>=20){  
                tick = 0;              
                candleTick++; 
                candles.push([(candleTick*20).toString(),price,price,price,price])
                negocios.push([(candleTick*20).toString(),0])
            }

            drawChart();  

            $('#precoCorrente').html('R$ ' + (price.toFixed(2)));
            var ab = $('#valorAbertura').val()
            tempProc = parseInt(ab)*100   
            var variac = (((price/ab)*100)-100).toFixed(2);            
            $('#variacaoCorrente').html(variac + '%');
            if(variac<0){
              $('#variacaoCorrente').css('color','deeppink')
            }else{
              $('#variacaoCorrente').css('color','darkblue')
            }
        }

        function drawChart() {
                var data = google.visualization.arrayToDataTable(candles, true);

                var options = {
                legend:'none'
                };

                var chart = new google.visualization.CandlestickChart(document.getElementById('chart_div'));

                chart.draw(data, options);

                var data1 = google.visualization.arrayToDataTable(negocios,true);
                var chart1 = new google.visualization.ColumnChart(document.getElementById("columnchart_values"));
                chart1.draw(data1, options);

            }

            function drawTable(tipo) {
              if(tipo==undefined)
                return

              var data = new google.visualization.DataTable();  
              var cor = 'red'
              if(tipo == "Compra"){
                data.addColumn('string', 'QTD');
                data.addColumn('string', 'Preço');              
                var cor = 'blue'
              }else{
                data.addColumn('string', 'Preço');              
                data.addColumn('string', 'QTD');
              }

              var tempBookOfertas = []
              for(var i  = 0 ; i < 10; i++){
                if(tipo=="Compra"){
                  tempBookOfertas.push([kFormatter(bookBuffer[24-i][0]).toString(),bookBuffer[24-i][1].toString()]);
                }else{
                  tempBookOfertas.push([bookBuffer[26+i][1].toString(),kFormatter(bookBuffer[26+i][0]).toString()]);
                }
              }

              data.addRows(tempBookOfertas);              

              var table = new google.visualization.Table(document.getElementById('table_div'+tipo));

              
              table.draw(data, 
                {
                  showRowNumber: true,
                  allowHtml: true,
                  cssClassNames: {    
                    oddTableRow: 'tableRow'+cor,
                    tableRow: 'tableRow'+cor
                  } , 
                  width: '100%', 
                  height: '100%'
                });
            }

            function inicarVariaveis(){
              var ab = $('#valorAbertura').val()
              ultimoPreco = parseInt(ab)*100              
              candles[0][1] = ultimoPreco/100
              candles[0][2] = ultimoPreco/100
              candles[0][3] = ultimoPreco/100
              candles[0][4] = ultimoPreco/100
              
            }

            function iniciarBook(){
                for(var i = 0 ; i < 50; i++){
                    bookBuffer.push([i,ultimoPreco-25+i])                    
                }
            }

            function lancarOrdensNoBook(){
                //var precoCorrente = ultimoPreco;
                liquidarNegocios();  
                //LANCAR RANDOMICO DE TENDENCIA E BOTAR NO PESO DO PRECO            
                for(var i = 0 ; i < 25; i++){
                  bookBuffer[i][0] = bookBuffer[i][0] + ((Math.floor(Math.random() * 100) ) * i);
                  bookBuffer[49-i][0] = bookBuffer[49-i][0] + ((Math.floor(Math.random() * 100) ) * i);                    
                }                            
            }

            function liquidarNegocios(){
              var randOk = Math.floor(Math.random() * 3)              
              //var compraMercadoValor = parseInt($('#compraMercado').val());
              if(compraMercadoValor!=0){                
                if(compraMercadoValor<0){
                  randOk = 0;
                  compraMercadoValor = compraMercadoValor*-1
                }else
                  randOk = 1;
              }
              if(randOk==0){
                //price = price-1;//randOk
                //VENDER A MERCADO    
                var tentativas = 20;

                while(true){        
                  tentativas--;                      
                  var tempBuffer = []
                  var negociosAgora = bookBuffer[26][0];
                  console.log(negociosAgora)
                  //if(tentativas<0 && negociosAgora==0)
                  //  break;
                  negocios[candleTick.toString()][1] = negocios[candleTick.toString()][1] + negociosAgora
                  bookBuffer[26][0] = 0;                               

                  ultimoPreco = ultimoPreco-1; 
                  tempBuffer.push([0,ultimoPreco-25])
                  for(var i = 0 ; i < 49; i++){
                    tempBuffer.push(bookBuffer[i])
                  }
                  bookBuffer = tempBuffer;     
                  compraMercadoValor = compraMercadoValor - negociosAgora
                  if(compraMercadoValor<0){
                    compraMercadoValor = 0;
                    //$('#compraMercado').val('0')
                    break;
                  }
                }
              }
              if(randOk==1){
                //price = price+1;//+randOk-5
                //COMPRAR A MERCADO 
                var tentativas = 20;
                while(true){      
                  tentativas--;
                  
                  var tempBuffer = []
                  
                  var negociosAgora = bookBuffer[24][0];
                  console.log(negociosAgora)
                  //if(tentativas<0 && negociosAgora == 0)
                  //  break;
                  negocios[candleTick.toString()][1] = negocios[candleTick.toString()][1] + negociosAgora
                  bookBuffer[24][0] = 0;
                  ultimoPreco = ultimoPreco+1;
                  for(var i = 0 ; i < 49; i++){
                    tempBuffer.push(bookBuffer[i+1])
                  }
                  tempBuffer.push([0,ultimoPreco+25])
                  bookBuffer = tempBuffer; 
                  compraMercadoValor = compraMercadoValor - negociosAgora
                  if(compraMercadoValor<0){
                    compraMercadoValor = 0;
                    //$('#compraMercado').val('0')
                    break;
                  } 
                }
                
              }
                // //LIQUIDANDO NEGOCIOS
                // if(bookOfertas[10][1] > bookOfertas[11][4]){
                //   //Tem mais venda q compra
                //   bookOfertas[10][1] -= bookOfertas[11][4]
                //   bookOfertas[11][4] = 0;

                // }else if(bookOfertas[10][1] < bookOfertas[11][4]){
                //   //Tem mais Compra q venda
                //   bookOfertas[11][4] -= bookOfertas[10][1]
                //   bookOfertas[10][1] = 0
                // }else{
                //   //Mesma quantidade de compra venda
                // }

            }

            function comprarMercado(){
              compraMercadoValor = parseInt($('#volume').val())
            }

            function venderMercado(){
              compraMercadoValor = parseInt($('#volume').val())*-1
            }

            function lancarCompraMercado(){
              var tempVol = parseInt($('#volume').val())
              var tempPrec = parseInt($('#lancarPreco').val())
              console.log(tempPrec)
              for(var i = 0 ; i < 50; i++){
                if(bookBuffer[i][1]==tempPrec){
                  bookBuffer[i][0] = bookBuffer[i][0] + tempVol
                  break;
                }
              }
            }

            function kFormatter(num) {
                return Math.abs(num) > 999 ? Math.sign(num)*((Math.abs(num)/1000).toFixed(1)) + 'k' : Math.sign(num)*Math.abs(num)
            }
    </script>
    <style>
      
    .google-visualization-table-td {
      text-align: center;
    }
    .tableRowblue{
      color:darkblue
    }
    .tableRowred{
      color:deeppink
    }
    </style>
  </head>
  <body>
    <label for='valorAbertura'>VALOR ABERTURA:</label>
    <input type='text' value="15" id='valorAbertura'>
    <input type="button" onclick="startTrade()" value="START"/>
    <input type="button" onclick="stopTrade()" value="STOP"/>
    <input type='text' value="0" id='volume'>
    <input type="button" onclick="comprarMercado()" value="COMPRAR MERCADO"/>
    <input type="button" onclick="venderMercado()" value="VENDER MERCADO"/>
    <input type="button" onclick="lancarCompraMercado()" value="COMPRA"/>
    <input type="button" onclick="lancarCompraMercado()" value="VENDA"/>
    <input type='text' value="0" id='lancarPreco'>
    <div><span style="color:darkblue;" id='precoCorrente'></span><span style="color: blue; padding-left: 2%;" id='variacaoCorrente'>0%</span></div>
    <div id="chart_div" style="width: 400px; height: 500px;"></div>
    <div id="columnchart_values" style="width: 400px; height: 100px;"></div>
    <div id="table_divCompra" style="width: 150px; height: 300px; display: table-cell;"></div>
    <div id="table_divVenda" style="width: 150px; height: 300px; display: table-cell;"></div>
    
  </body>
</html>