<html>
  <head>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script type="text/javascript">

      var myVar;// = setInterval(alertFunc, 1000);
      var candleTick = 0;
      var candles = [['0',15,15,15,15]]
      var bookOfertasCompra = []
      var bookOfertasVenda = []
      var negocios = []
      var ultimPreco = 1500;
      var tick = 0;

      function startTrade(){
        inicarVariaveis();
        iniciarBook();
        google.charts.load('current', {'packages':['corechart','table']});
        google.charts.setOnLoadCallback(drawChart);      
        google.charts.setOnLoadCallback(drawTable);
        myVar = setInterval(alertFunc, 1000);
      }

        function stopTrade(){
            if(myVar)
              clearInterval(myVar);
        }

        function alertFunc() {
            
            //ultimPreco = ultimPreco-5;
            // var randOk = Math.floor(Math.random() * 3)
            // //console.log(randOk)
            // var price = ultimPreco;
            // if(randOk==0)
            //     price = price-1;//randOk
            // if(randOk==1)
            //     price = price+1;//+randOk-5
            
            //ultimPreco = price;
            var price = ultimPreco/100;
            
            if(candles[candleTick][1]> price)
                candles[candleTick][1] = price
            
            candles[candleTick][2] = price

            if(candles[candleTick][4]< price)
                candles[candleTick][4] = price
            
            tick++;
            if(tick>=20){  
                tick = 0;              
                candleTick++; 
                candles.push([(candleTick*20).toString(),price,price,price,price])
            }

            lancarOrdensNoBook()

            drawChart();
            drawTable(bookOfertasCompra,'Compra');
            drawTable(bookOfertasVenda,'Venda');
        }

        function drawChart() {
                var data = google.visualization.arrayToDataTable(candles, true);

                var options = {
                legend:'none'
                };

                var chart = new google.visualization.CandlestickChart(document.getElementById('chart_div'));

                chart.draw(data, options);
            }

            function drawTable(bookOfertas,tipo) {
              if(tipo==undefined)
                return

              var data = new google.visualization.DataTable();  
              var cor = 'red'
              if(tipo == "Compra"){
                data.addColumn('string', 'QTD');
                data.addColumn('string', 'Preço');              
                var cor = 'blue'
              }else{
                data.addColumn('string', 'Preço');              
                data.addColumn('string', 'QTD');
              }

              var tempBookOfertas = []
              for(var i  = 0 ; i < 10; i++){
                if(tipo=="Compra"){
                  tempBookOfertas.push([bookOfertas[i][0].toString(),bookOfertas[i][1].toString()]);
                }else{
                  tempBookOfertas.push([bookOfertas[i][1].toString(),bookOfertas[i][0].toString()]);
                }
              }

              data.addRows(tempBookOfertas);              

              var table = new google.visualization.Table(document.getElementById('table_div'+tipo));

              
              table.draw(data, 
                {
                  showRowNumber: false,
                  allowHtml: true,
                  cssClassNames: {    
                    oddTableRow: 'tableRow'+cor,
                    tableRow: 'tableRow'+cor
                  } , 
                  width: '100%', 
                  height: '100%'
                });
            }

            function inicarVariaveis(){
              var ab = $('#valorAbertura').val()
              ultimPreco = parseInt(ab)*100              
              candles[0][1] = ultimPreco/100
              candles[0][2] = ultimPreco/100
              candles[0][3] = ultimPreco/100
              candles[0][4] = ultimPreco/100
              
            }

            function iniciarBook(){
                for(var i = 0 ; i < 11; i++){
                    bookOfertasCompra.push([0,ultimPreco-1])
                    bookOfertasVenda.push([0,ultimPreco+1])
                }
            }

            function lancarOrdensNoBook(){
                var precoCorrente = ultimPreco;
                //LANCAR RANDOMICO DE TENDENCIA E BOTAR NO PESO DA QTD               
                for(var i = 0 ; i < 10; i++){
                    bookOfertasCompra[i][0] = bookOfertasCompra[i][0] + (Math.floor(Math.random() * 10) );
                    //bookOfertasCompra[i][1] = precoCorrente -1 - i;

                    bookOfertasVenda[i][0] = bookOfertasVenda[i][0] + (Math.floor(Math.random() * 10) );
                    //bookOfertasVenda[i][1] = precoCorrente +1 + i ;
                }
                liquidarNegocios();
            }

            function liquidarNegocios(){
              var randOk = Math.floor(Math.random() * 3)
              //console.log(randOk)
              var price = ultimPreco;
              if(randOk==0){
                //price = price-1;//randOk
                //VENDER A MERCADO
                for(var i = 0 ; i < 10; i++){
                    if(i+1 <10){
                      bookOfertasCompra[i] = bookOfertasCompra[i+1]
                    }else{
                      bookOfertasCompra[i][0] = 0//push([0,bookOfertasCompra[i][1]+1])
                      bookOfertasCompra[i][1] = bookOfertasCompra[i][1]-1
                    }
                }
                ultimPreco--;
              }
              if(randOk==1){
                //price = price+1;//+randOk-5
                //COMPRAR A MERCADO 

                ultimPreco++;
              }
                // //LIQUIDANDO NEGOCIOS
                // if(bookOfertas[10][1] > bookOfertas[11][4]){
                //   //Tem mais venda q compra
                //   bookOfertas[10][1] -= bookOfertas[11][4]
                //   bookOfertas[11][4] = 0;

                // }else if(bookOfertas[10][1] < bookOfertas[11][4]){
                //   //Tem mais Compra q venda
                //   bookOfertas[11][4] -= bookOfertas[10][1]
                //   bookOfertas[10][1] = 0
                // }else{
                //   //Mesma quantidade de compra venda
                // }

            }
    </script>
    <style>
      
    .google-visualization-table-td {
      text-align: center;
    }
    .tableRowblue{
      color:blue
    }
    .tableRowred{
      color:red
    }
    </style>
  </head>
  <body>
    <label for='valorAbertura'>VALOR ABERTURA:</label>
    <input type='text' value="15" id='valorAbertura'>
    <input type="button" onclick="startTrade()" value="START"/>
    <input type="button" onclick="stopTrade()" value="STOP"/>
    <div id="chart_div" style="width: 900px; height: 500px;"></div>
    <div id="table_divCompra" style="width: 150px; height: 300px; display: table-cell;"></div>
    <div id="table_divVenda" style="width: 150px; height: 300px; display: table-cell;"></div>
    
  </body>
</html>